# 特别说明

对于中国开发者而言，运行时权限是我们的一个痛点，AndPermission2.0发布之前邀请了很多中国开发者参与测试，测试并兼容了大量的中国产手机。虽然如此，但是在很多手机上测试结果还是不尽如人意，但是这些手机只是很少的一部分了，AndPermission也提供了合适的方法来兼容这种情况。

国产手机的各种情况比较多，这里就不一一例举说明了，这里说明一些使用AndPermission时出现的疑问。

为了兼容一些特殊中国产手机，AndPermission请求权限的流程做了一些优化：
```
						 发起请求
							│
				调用SDK Api判断是否有权限
				            │
			┌───────────────┴───────────────┐
			│                               │
	      有权限                          没权限
			│                               │
			│                               │
			│						使用SDK Api请求权限
			│                               │
			│                               │
			│						 用户授权或者拒绝
			│                               │
			└───────────────┬───────────────┘
							│
				      执行权限相关代码
                            │
				    ┌───────┴───────┐
                    │               │
				   正常            异常
                    │               │
               onGranted()      onDenied()
				    │
             ┌──────┴──────┐
             │             │
			正常          异常
			               |
					   onDenied()
```

## 申请流程的释义
可以看出AndPermission的申请流程和SDK Api的流程大相径庭，这样做主要是因为以下几点原因。

* 兼容Android5.0的系统判断是否有权限。
* 一部分设备上使用SDK的Api判断是否有权限时总是返回`true`，因此需要执行权限相关代码根据是否抛出异常来判断是否真正有权限。
* 一部分设备在申请权限时并不会弹出授权Dialog，而是在真正调用权限相关代码时才会弹出授权Dialog。
* 一部分设备在用户点击授权后并不会真正的授权，当开发者执行权限相关代码时会发生异常。
* 一部分权限（例如*发送短信、*打电话*、*接听/挂断电话*等），AndPermission不能执行权限相关代码来判断或者强制申请。

## 一些特例权限
* *身体传感器*是手表上使用的，非手表开发者是用不到*身体传感器*权限的，在绝大部分手机上都没有*身体传感器*，这种情况下一部分手机是直接返回有权限，一部分手机无论如何都会返回无权限。**在手表上测试身体传感器权限时不存在问题**。
* *获取手机账户*、*读取短信*和*定位*权限在部分手机上没权限时不会弹出授权Dialog，并且会告诉AndPermission有此权限，在做验证时执行权限相关代码也不会抛出异常，获取到的结果是null或者0。因此AndPermission只能认为是有权限的，开发者尽管在`onGranted()`中执行权限相关代码即可，AndPermission可以保证没有权限时App不会崩溃，获取到结果是null时，可以提示用户没有信息或者去检查权限等。
* 一些开发者申请*电话*权限时直接申请了**电话权限组**，但是有的设备中`PROCESS_OUTGOING_CALLS`权限只允许系统App，不允许普通App获取。因此**对于电话权限，使用什么权限就申请什么权限**，不要申请权限组。

## 申请流程的步骤
* 第一步，对于任何一个授权请求，AndPermission首先使用SDK Api来判断是否有权限，如果有权限则直接进入第三步。
* 第二步，没有权限则调用SDK Api请求用户授权，不论用户是否授权都进入第三步。
* 第三步，执行权限相关代码，如果发生异常则认为没有权限，然后回调`onDenied()`方法，如果没有发生异常则回调`onGranted()`。

> 回调`onGranted()`时AndPermission对`onGranted()`方法做了`try catch`。这样做可以保证两点，第一点是在部分手机实在无法获取权限真正的状态时回调了`onGranted()`后没权限造成的崩溃，第二点是部分手机需要真正执行权限相关代码时弹出授权Dialog后被用户拒绝而造成的崩溃。而这两点都是没有权限，因此会重新回调到`onDenied()`中让开发者处理没权限的情况。

还有些权限也有同样的问题，这里不再过多解释，有问题的开发者可以在[AndPermission/issues](https://github.com/yanzhenjie/AndPermission/issues)提问。

## 总结
有一个原则是**使用什么权限就申请什么权限**，不要过多的申请权限。比如**电话**、**短信**和**联系人**这种隐私级别比较高的要特别注意；比如**日历**、**相机**、**定位**、**麦克风**和**存储空间**这些常用且隐私级别不高的权限可以请求权限组，这些权限经过测试存在的问题也比较少。

AndPermission从2.0版本开始不再需要开发者从代码的实现上特别写什么判断了，按照文档中的规范使用即可。

另外，上述提到AndPermission在回调`onGranted()`时做了`try catch`，内部的实现如下：
```
private void callbackSucceed() {
	if (mGranted != null) {
		List<String> permissionList = asList(mPermissions);
		try {
			mGranted.onAction(permissionList);
		} catch (Exception e) {
			if (mDenied != null) {
				mDenied.onAction(permissionList);
			}
		}
	}
}
```

当开发者执行有权限的代码发生异常时，AndPermission会抓到异常并回调到失败中，这里要注意的是会抓到任何异常，不仅仅是没有权限时的异常。